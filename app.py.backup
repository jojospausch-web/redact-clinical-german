#!/usr/bin/env python3
"""
Streamlit Web UI for German Clinical Document Anonymization.

This provides a user-friendly web interface for batch upload and download
of anonymized medical documents (PDFs).
"""

import streamlit as st
from pathlib import Path
import zipfile
import io
import logging
import sys
import tempfile
import os
import re

# Add src to path
sys.path.insert(0, str(Path(__file__).parent))

from src.main import anonymize_pdf_with_template
from src.template_generator import create_custom_template
from src.preview_generator import create_preview_with_zones

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Page configuration
st.set_page_config(
    page_title="Redact Clinical German",
    page_icon="üè•",
    layout="wide"
)

# Custom CSS
st.markdown("""
<style>
    .stButton>button {
        width: 100%;
    }
    .success-box {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }
</style>
""", unsafe_allow_html=True)

# Initialize session state
if 'results' not in st.session_state:
    st.session_state['results'] = []

# Title and description
st.title("üè• Redact Clinical German")
st.markdown("**Anonymisierung deutscher medizinischer Arztbriefe**")

# File upload
uploaded_files = st.file_uploader(
    "üìÇ Arztbriefe hochladen (PDF)",
    type=['pdf'],
    accept_multiple_files=True,
    help="Sie k√∂nnen mehrere PDF-Dateien gleichzeitig hochladen"
)

if uploaded_files:
    st.success(f"‚úÖ {len(uploaded_files)} Datei(en) hochgeladen")
    
    # ======= ZONE CONFIGURATION SECTION =======
    st.header("‚öôÔ∏è Zonen-Einstellungen")
    st.markdown("**Diese Einstellungen gelten f√ºr ALLE hochgeladenen PDFs**")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("üìè Header-Bereich")
        header_height = st.slider(
            "Header-H√∂he (Pixel von oben)",
            min_value=0,
            max_value=300,
            value=150,
            step=10,
            help="Bereich, der am oberen Seitenrand geschw√§rzt wird"
        )
        
        header_page = st.selectbox(
            "Header schw√§rzen auf",
            options=["Nur Seite 1", "Allen Seiten"],
            index=0
        )
    
    with col2:
        st.subheader("üìè Footer-Bereich")
        footer_height = st.slider(
            "Footer-H√∂he (Pixel von unten)",
            min_value=0,
            max_value=200,
            value=92,
            step=10,
            help="Bereich, der am unteren Seitenrand geschw√§rzt wird"
        )
        
        footer_keywords = st.multiselect(
            "Footer-Keywords (optional)",
            options=["IBAN", "Bankverbindung", "Sparkasse", "BIC", "Stiftung", "Vorstand"],
            default=["IBAN", "Bankverbindung", "Sparkasse"],
            help="Nur Bereiche mit diesen Keywords werden im Footer geschw√§rzt"
        )
    
    # ======= LIVE PREVIEW SECTION =======
    st.header("üìÑ Vorschau mit Schw√§rzungs-Bereichen")
    
    try:
        # Show preview of FIRST PDF
        first_pdf = uploaded_files[0]
        
        # Create preview image with drawn zones
        preview_image = create_preview_with_zones(
            pdf_file=first_pdf,
            header_height=header_height,
            footer_height=footer_height
        )
        
        st.image(preview_image, caption=f"Vorschau: {first_pdf.name}", use_column_width=True)
        
        st.info(f"üîµ **Blauer Bereich** = Header ({header_height}px von oben) | "
                f"üü† **Oranger Bereich** = Footer ({footer_height}px von unten)")
    except Exception as e:
        st.error(f"‚ùå Fehler bei Vorschau-Generierung: {str(e)}")
        logger.error(f"Preview generation failed: {e}", exc_info=True)
    
    # ======= ANONYMIZATION SECTION =======
    st.header("üöÄ Anonymisierung")
    
    with st.expander("üîß Erweiterte Einstellungen", expanded=False):
        shift_days = st.slider(
            "Datums-Shift (Tage)",
            min_value=-90,
            max_value=90,
            value=25,
            help="Positive = Zukunft, Negative = Vergangenheit"
        )
        
        extract_images = st.checkbox("Bilder extrahieren", value=True)
    
    if st.button("üöÄ Anonymisierung starten", type="primary", use_container_width=True):
        # Create dynamic template based on user settings
        try:
            custom_template = create_custom_template(
                header_height=header_height,
                header_page="1" if header_page == "Nur Seite 1" else "all",
                footer_height=footer_height,
                footer_keywords=footer_keywords
            )
        except Exception as e:
            st.error(f"‚ùå Fehler beim Erstellen des Templates: {str(e)}")
            logger.error(f"Template creation failed: {e}", exc_info=True)
            st.stop()
        
        # Clear previous results
        st.session_state['results'] = []
        
        # Progress tracking
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        results = []
        total = len(uploaded_files)
        
        for idx, uploaded_file in enumerate(uploaded_files):
            status_text.text(f"Verarbeite {uploaded_file.name} ({idx+1}/{total})...")
            
            # Sanitize filename to prevent path traversal attacks
            safe_filename = re.sub(r'[^\w\s.-]', '_', uploaded_file.name)
            safe_filename = os.path.basename(safe_filename)
            
            # Create unique temporary directory for this file
            temp_dir = tempfile.mkdtemp(prefix='redact_')
            temp_input = Path(temp_dir) / safe_filename
            temp_input.write_bytes(uploaded_file.read())
            
            # Create temp output directory
            temp_output_dir = Path(temp_dir) / "output"
            temp_output_dir.mkdir(parents=True, exist_ok=True)
            temp_output = temp_output_dir / f"anonymized_{safe_filename}"
            
            # Call anonymization with custom template
            try:
                result = anonymize_pdf_with_template(
                    input_path=str(temp_input),
                    template=custom_template,
                    output_path=str(temp_output),
                    shift_days=shift_days,
                    extract_images=extract_images
                )
                
                results.append({
                    'original_name': uploaded_file.name,
                    'anonymized_pdf': result['output_pdf'],
                    'images': result.get('images', []),
                    'stats': result.get('stats', {})
                })
                
                logger.info(f"Successfully processed {uploaded_file.name}")
                
            except Exception as e:
                logger.error(f"Error processing {uploaded_file.name}: {e}", exc_info=True)
                st.error(f"‚ùå Fehler bei {uploaded_file.name}: {str(e)}")
            
            # Update progress
            progress_bar.progress((idx + 1) / total)
        
        status_text.text("‚úÖ Fertig!")
        
        # Store results in session state
        st.session_state['results'] = results

if uploaded_files:
    if st.button("üöÄ Anonymisierung starten", type="primary"):
        # Clear previous results
        st.session_state['results'] = []
        
        # Progress tracking
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        results = []
        total = len(uploaded_files)
        
        for idx, uploaded_file in enumerate(uploaded_files):
            status_text.text(f"Verarbeite {uploaded_file.name} ({idx+1}/{total})...")
            
            # Sanitize filename to prevent path traversal attacks
            safe_filename = re.sub(r'[^\w\s.-]', '_', uploaded_file.name)
            safe_filename = os.path.basename(safe_filename)  # Remove any path components
            
            # Create unique temporary directory for this file
            temp_dir = tempfile.mkdtemp(prefix='redact_')
            temp_input = Path(temp_dir) / safe_filename
            temp_input.write_bytes(uploaded_file.read())
            
            # Create temp output directory
            temp_output_dir = Path(temp_dir) / "output"
            temp_output_dir.mkdir(parents=True, exist_ok=True)
            temp_output = temp_output_dir / f"anonymized_{safe_filename}"
            
            # Call anonymization
            try:
                # shift_days: 0 means random shift (None triggers random behavior in backend)
                result = anonymize_pdf(
                    input_path=str(temp_input),
                    template_path=template_file,
                    output_path=str(temp_output),
                    shift_days=shift_days if shift_days != 0 else None,
                    extract_images=extract_images
                )
                
                results.append({
                    'original_name': uploaded_file.name,
                    'anonymized_pdf': result['output_pdf'],
                    'images': result.get('images', []),
                    'stats': result.get('stats', {})
                })
                
                logger.info(f"Successfully processed {uploaded_file.name}")
                
            except Exception as e:
                logger.error(f"Error processing {uploaded_file.name}: {e}")
                st.error(f"‚ùå Fehler bei {uploaded_file.name}: {str(e)}")
            
            # Update progress
            progress_bar.progress((idx + 1) / total)
        
        status_text.text("‚úÖ Fertig!")
        
        # Store results in session state
        st.session_state['results'] = results

# Download section
if 'results' in st.session_state and st.session_state['results']:
    st.success(f"‚úÖ {len(st.session_state['results'])} Dateien erfolgreich anonymisiert!")
    
    # Individual downloads
    st.subheader("üì• Einzelne Dateien herunterladen")
    
    cols = st.columns(3)
    for idx, result in enumerate(st.session_state['results']):
        col = cols[idx % 3]
        with col:
            st.markdown(f"**{result['original_name']}**")
            
            # PDF download
            with open(result['anonymized_pdf'], 'rb') as f:
                st.download_button(
                    label="üìÑ PDF",
                    data=f.read(),
                    file_name=f"anonymized_{result['original_name']}",
                    mime="application/pdf",
                    key=f"pdf_{idx}"
                )
            
            # Stats
            stats = result['stats']
            st.caption(f"Seiten: {stats.get('total_pages', 0)}")
            st.caption(f"PII gefunden: {stats.get('pii_entities_found', 0)}")
            st.caption(f"Zonen redaktiert: {stats.get('zones_redacted', 0)}")
    
    # Bulk ZIP download
    st.subheader("üì¶ Alle als ZIP herunterladen")
    
    zip_buffer = io.BytesIO()
    with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        for result in st.session_state['results']:
            # Add PDF
            with open(result['anonymized_pdf'], 'rb') as f:
                zip_file.writestr(
                    f"anonymized_{result['original_name']}",
                    f.read()
                )
            
            # Add images if any
            for img_idx, img_path in enumerate(result['images']):
                with open(img_path, 'rb') as f:
                    zip_file.writestr(
                        f"images/{result['original_name']}_image_{img_idx}.png",
                        f.read()
                    )
    
    st.download_button(
        label="üì¶ Alle Dateien als ZIP herunterladen",
        data=zip_buffer.getvalue(),
        file_name="anonymized_batch.zip",
        mime="application/zip"
    )

# Info section when no files uploaded
if not uploaded_files:
    st.info("""
    ### üìã Anleitung
    
    1. **Hochladen**: W√§hlen Sie eine oder mehrere PDF-Dateien aus
    2. **Konfigurieren**: Passen Sie die Einstellungen in der Sidebar an
    3. **Starten**: Klicken Sie auf "Anonymisierung starten"
    4. **Herunterladen**: Laden Sie einzelne Dateien oder alle als ZIP herunter
    
    ### ‚ú® Features
    
    - ‚úÖ Mehrere PDFs gleichzeitig hochladen
    - ‚úÖ Batch-Verarbeitung mit Live-Progress
    - ‚úÖ Einzeldownload jeder anonymisierten Datei
    - ‚úÖ ZIP-Download aller Dateien auf einmal
    - ‚úÖ Konfigurierbare Anonymisierung
    - ‚úÖ Statistiken pro Datei
    """)
